name: Deploy Proxmox Helper Bot

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: bash

    env:
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      PVE_HOST: ${{ secrets.PVE_HOST }}
      PVE_PORT: ${{ secrets.PVE_PORT }}
      PVE_NODE: ${{ secrets.PVE_NODE }}
      PVE_TOKEN: ${{ secrets.PVE_TOKEN }}
      CF_TOKEN: ${{ secrets.CF_TOKEN }}
      DOMAIN: ${{ secrets.DOMAIN }}
      ADMIN_IDS: ${{ secrets.ADMIN_IDS }}
      DEFAULT_GW: ${{ vars.DEFAULT_GW }}
      DEFAULT_DNS: ${{ vars.DEFAULT_DNS }}
      IP_RANGE_START: ${{ vars.IP_RANGE_START }}
      IP_RANGE_END: ${{ vars.IP_RANGE_END }}
      DEFAULT_VM_USER: ${{ secrets.DEFAULT_VM_USER }}
      BANNER_FILE_ID: ${{ vars.BANNER_FILE_ID }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_PASS: ${{ secrets.VPS_PASS }}
      BOT_PATH: /home/github/mybot

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Sync code to $BOT_PATH
        run: |
          echo "[DEPLOY] Syncing code to $BOT_PATH..."
          mkdir -p "$BOT_PATH"
          mkdir -p "$BOT_PATH/log"
          rsync -a --delete ./ "$BOT_PATH"/

      - name: Build and restart Docker container
        run: |
          cd "$BOT_PATH"
          echo "[DEPLOY] Files in $(pwd):"
          ls -la
          docker compose down || true
          docker compose up -d --build --force-recreate --no-cache

      - name: Verify bot container is running
        run: |
          echo "[CHECK] Active containers:"
          docker ps --filter "name=proxmox-helper-bot" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo
          echo "[CHECK] Last 20 log lines from container:"
          docker logs proxmox-helper-bot --tail 20 || (echo "[ERROR] Bot container not found or failed to start" && exit 1)
          echo
          echo "[CHECK] Host log directory contents:"
          ls -lh "$BOT_PATH/log" || echo "[WARN] log dir empty"

      - name: Clean up unused images
        if: always()
        run: |
          docker image prune -af || true
