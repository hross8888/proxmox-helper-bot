name: Deploy Proxmox Helper Bot

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Define paths
        run: |
          export BOT_PATH=/home/github/mybot
          echo "BOT_PATH=$BOT_PATH" >> $GITHUB_ENV

      - name: Sync code to server
        run: |
          rsync -a --delete \
            --exclude='__pycache__/' \
            --exclude='*.pyc' \
            --exclude='log/' \
            --exclude='*.db' \
            ./ "$BOT_PATH"/

      ######################################################################
      # (1) ОБНОВЛЕНИЕ Docker Swarm Secrets из GitHub Secrets
      ######################################################################
      - name: Update Swarm secrets
        run: |
          update_secret() {
            name="$1"
            value="$2"
            echo "[SWARM] Updating secret: $name"
            docker secret rm "$name" 2>/dev/null || true
            echo -n "$value" | docker secret create "$name" -
          }

          update_secret REDIS_HOST      "${{ secrets.REDIS_HOST }}"
          update_secret BOT_TOKEN       "${{ secrets.BOT_TOKEN }}"
          update_secret PVE_HOST        "${{ secrets.PVE_HOST }}"
          update_secret PVE_PORT        "${{ secrets.PVE_PORT }}"
          update_secret PVE_NODE        "${{ secrets.PVE_NODE }}"
          update_secret PVE_TOKEN       "${{ secrets.PVE_TOKEN }}"
          update_secret CF_TOKEN        "${{ secrets.CF_TOKEN }}"
          update_secret DOMAIN          "${{ secrets.DOMAIN }}"
          update_secret ADMIN_IDS       "${{ secrets.ADMIN_IDS }}"
          update_secret DEFAULT_VM_USER "${{ secrets.DEFAULT_VM_USER }}"
          update_secret VPS_HOST        "${{ secrets.VPS_HOST }}"
          update_secret VPS_USER        "${{ secrets.VPS_USER }}"
          update_secret VPS_PASS        "${{ secrets.VPS_PASS }}"

          # vars
          update_secret DEFAULT_GW      "${{ vars.DEFAULT_GW }}"
          update_secret DEFAULT_DNS     "${{ vars.DEFAULT_DNS }}"
          update_secret IP_RANGE_START  "${{ vars.IP_RANGE_START }}"
          update_secret IP_RANGE_END    "${{ vars.IP_RANGE_END }}"
          

      ######################################################################
      # (1.5) Остановка и удаление стека для возможности обновления секретов
      ######################################################################
      - name: Stop and remove existing stack
        run: |
          echo "[SWARM] Removing old stack to free up secrets..."
          docker stack rm proxmoxbot || true
          sleep 5
      ######################################################################
      # (2) ДЕПЛОЙ стекa через docker stack
      ######################################################################
      - name: Deploy SWARM stack
        run: |
          docker stack deploy -c "$BOT_PATH/stack.yml" proxmoxbot

      ######################################################################
      # (3) ПРОВЕРКА, что сервис запущен
      ######################################################################
      - name: Verify service is running
        run: |
          echo "[CHECK] Services:"
          docker service ls
          echo
          echo "[CHECK] Logs:"
          docker service logs proxmoxbot_proxmox-helper-bot --tail 50 || true

      ######################################################################
      # (4) Очистка старых образов
      ######################################################################
      - name: Cleanup images
        if: always()
        run: docker image prune -af || true
